#!/bin/bash

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Extensiones ejecutables
EXEC_EXTENSIONS=("bat" "exe" "js" "py" "sh" "bin" "appimage" "deb" "rpm" "msi" "com" "scr" "pif" "cmd" "vbs" "ps1" "jar")

# Patrones maliciosos
PATTERNS=(
    "/dev/tcp" "bash -i" "exec.*bash" "python -c" "stratum+tcp" 
    "xmr.*pool" "bitcoin" "btc" "Invoke-Expression" "DownloadString"
    "Net.WebClient" "powershell.*enc" "vssadmin.*delete" "CoinHive"
)

echo -e "${YELLOW}ðŸ” Escaneando archivos...${NC}"
echo "=========================================="

found_suspicious=0

for file in *; do
    if [[ -f "$file" ]]; then
        # Contar puntos para detectar doble extensiÃ³n
        dots=$(echo "$file" | tr -cd '.' | wc -c)
        
        if [ $dots -ge 2 ]; then
            # Extraer la ÃšLTIMA extensiÃ³n (la real)
            real_ext="${file##*.}"
            real_ext_lower=$(echo "$real_ext" | tr '[:upper:]' '[:lower:]')
            
            # Extraer todo antes de la Ãºltima extensiÃ³n para obtener la falsa
            base_part="${file%.*}"
            fake_ext="${base_part##*.}"
            
            echo -e "${YELLOW}âš ï¸  DOBLE EXTENSIÃ“N: $file${NC}"
            echo -e "   Real: .$real_ext | Falsa: .$fake_ext"
            
            if [[ " ${EXEC_EXTENSIONS[@]} " =~ " ${real_ext_lower} " ]]; then
                echo -e "   ${RED}ðŸš¨ EXTENSIÃ“N EJECUTABLE OCULTA: .$real_ext${NC}"
                
                # Analizar contenido
                echo -e "   ${YELLOW}ðŸ“ Contenido del archivo:${NC}"
                strings_output=$(strings "$file" 2>/dev/null | head -n 30)
                
                # Mostrar contenido
                if [ -n "$strings_output" ]; then
                    echo "$strings_output" | while IFS= read -r line; do
                        echo -e "      $line"
                    done
                fi
                
                # Buscar patrones maliciosos
                found_malicious=0
                for pattern in "${PATTERNS[@]}"; do
                    if echo "$strings_output" | grep -i -q "$pattern"; then
                        found_malicious=1
                        found_suspicious=1
                        echo -e "   ${RED}ðŸš¨ DETECTADO: $pattern${NC}"
                    fi
                done
                
                if [ $found_malicious -eq 0 ]; then
                    echo -e "   ${GREEN}âœ… No se encontrÃ³ cÃ³digo malicioso${NC}"
                    found_suspicious=1  # Sospechoso por doble extensiÃ³n
                fi
            else
                echo -e "   ${GREEN}âœ… ExtensiÃ³n real no es ejecutable${NC}"
            fi
            echo "   ------------------------------------"
        fi
    fi
done

echo "=========================================="
if [ $found_suspicious -eq 0 ]; then
    echo -e "${GREEN}âœ… SCAN COMPLETADO - Todo limpio${NC}"
else
    echo -e "${RED}ðŸš¨ SCAN COMPLETADO - Archivos sospechosos encontrados${NC}"
fi
