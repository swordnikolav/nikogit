#!/bin/sh

echo "==> Limpiando paquetes huérfanos..."
doas emerge -ac

echo "==> Analizando dependencias rotas..."
# Filtrar revdep-rebuild para evitar recompilar neovim
TMP_REBUILD=$(mktemp)
revdep-rebuild --pretend > "$TMP_REBUILD"

if grep -q app-editors/neovim "$TMP_REBUILD"; then
    echo "⚠️  Neovim aparecería en revdep-rebuild, será ignorado."
fi

# Extraer paquetes a recompilar, excluyendo neovim
TO_REBUILD=$(grep '\[ebuild' "$TMP_REBUILD" | awk '{print $4}' | grep -v neovim)

if [ -n "$TO_REBUILD" ]; then
    echo "==> Reconstruyendo paquetes necesarios (sin Neovim)..."
    echo "$TO_REBUILD" | xargs doas emerge --oneshot
else
    echo "✓ Nada que recompilar (aparte de Neovim, ignorado)."
fi

rm -f "$TMP_REBUILD"

echo "==> Ejecutando preserved-rebuild..."
doas emerge @preserved-rebuild

echo "==> Verificando integridad con qcheck..."
doas qcheck --update

echo "==> Corriendo emaint..."
doas emaint -c all

echo "==> Verificando linking de Neovim..."
if ldd /usr/bin/nvim | grep 'not found'; then
    echo "⚠️  Problemas con Neovim: librerías faltantes."
else
    echo "✓ Neovim está bien linkeado."
fi

echo "✅ Todo listo. Sistema mantenido."
