#!/bin/bash

# Uso:
#   ./inspeccionar_pids.sh 1 2 3 4
#   ./inspeccionar_pids.sh -f pids.txt

if [[ "$1" == "-f" ]]; then
  if [[ ! -f "$2" ]]; then
    echo "Archivo no encontrado: $2"
    exit 1
  fi
  PIDS=$(cat "$2")
else
  PIDS="$@"
fi

if [[ -z "$PIDS" ]]; then
  echo "Uso:"
  echo "  $0 123 456 789"
  echo "  $0 -f pids.txt"
  exit 1
fi

for PID in $PIDS; do
  if [[ ! -d "/proc/$PID" ]]; then
    echo -e "\n======== PID $PID (no existe) ========"
    continue
  fi

  echo -e "\n========================================="
  echo "   INFORMACIÓN DEL PROCESO: PID $PID"
  echo "========================================="

  echo -e "\n▶ PS:"
  ps -p "$PID" -o pid,ppid,user,stat,%cpu,%mem,cmd --width 200

  echo -e "\n▶ Ejecutable real:"
  readlink -f /proc/$PID/exe 2>/dev/null || echo "No accesible"

  echo -e "\n▶ Línea de comando:"
  tr '\0' ' ' < /proc/$PID/cmdline 2>/dev/null || echo "No accesible"

  echo -e "\n▶ Status (resumen):"
  egrep "Name|State|PPid|Uid|Gid|Threads|FDSize|Seccomp|Cpus_allowed_list" /proc/$PID/status 2>/dev/null

  echo -e "\n▶ Cgroup:"
  cat /proc/$PID/cgroup 2>/dev/null

  echo -e "\n▶ AppArmor / SELinux:"
  cat /proc/$PID/attr/current 2>/dev/null || echo "N/A"

  echo -e "\n▶ Archivos abiertos (top 10):"
  ls -l /proc/$PID/fd 2>/dev/null | head -n 10 || echo "No accesible"

  echo -e "\n▶ Conexiones de red:"
  ss -p 2>/dev/null | grep "pid=$PID," || echo "No se detectaron conexiones"

  echo -e "\n▶ Mapa de memoria (primeras 5 líneas):"
  head -n 5 /proc/$PID/maps 2>/dev/null || echo "No accesible"

done

