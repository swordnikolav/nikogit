#!/bin/bash

# =============================================================================
# System Information Fetcher for Gentoo Linux
# =============================================================================
#
# Description:
#   This script gathers and displays key system information, including hardware
#   details, package versions, and system configurations. It is designed for
#   Gentoo Linux environments and uses tools like qlist and lspci.
#
# Author: Grok (Generated by xAI)
# Version: 1.3
# Last Updated: December 02, 2025
#
# Usage:
#   ./system_info.sh [--no-color]
#
# Options:
#   --no-color    Disable color output for compatibility with non-ANSI terminals.
#
# Dependencies:
#   - tput (for colors)
#   - awk, sed, free, uname, lspci, qlist (Gentoo-specific from portage-utils)
#   - Optional: openrc, systemd, s6 for init detection
#
# Notes:
#   - Falls back to "N/A" for unavailable information.
#   - Theme: Cappuccino (inspired by Catppuccin Latte).
#   - Icons: Unicode icons for visual enhancement (requires UTF-8 locale and font support, e.g., Nerd Fonts).
#   - WM: Detects Hyprland as per user environment.
#   - Optimization: Uses a single qlist -Iv call to fetch all installed package data at once, then extracts
#     specific versions and count via grep and wc. This replaces multiple equery calls for better performance.
#     Removed 'doas' as qlist typically doesn't require elevated privileges (reads /var/db/pkg).
#     If qlist needs privileges in your setup, add 'doas' before qlist in the Data Collection section.
#
# =============================================================================

# =============================================================================
# Configuration
# =============================================================================

# Color theme: Cappuccino (adjust for terminal support)
USE_COLOR=true
if [[ "$1" == "--no-color" ]]; then
    USE_COLOR=false
fi

if $USE_COLOR; then
    C_LABEL=$(tput setaf 172)  # Marrón cappuccino for labels/headers
    C_VALUE=$(tput setaf 7)    # Blanco for values
    RESET=$(tput sgr0)
else
    C_LABEL=""
    C_VALUE=""
    RESET=""
fi

# Icons: Associative array for Unicode icons (fallback to empty if not supported)
declare -A ICONS
ICONS["System"]=" "         # Linux icon
ICONS["Init"]=" "          # Gear for init/system
ICONS["Kernel"]=" "        # Kernel icon
ICONS["Packages"]=" "      # Packages icon
ICONS["glibc"]=" "         # Library icon (generic)
ICONS["gcc"]=" "           # Compiler icon
ICONS["binutils"]=" "      # Tools icon
ICONS["xz"]=" "            # Archive icon
ICONS["python"]=" "        # Python icon
ICONS["mksh"]=" "          # Shell icon
ICONS["kitty"]=" "         # Terminal icon (kitty as term)
ICONS["wayland"]=" "       # Wayland icon
ICONS["hyprland"]=" "      # Hyprland icon (or generic WM)
ICONS["pipewire"]=" "      # Audio icon
ICONS["CPU"]=" "           # CPU icon
ICONS["GPU"]=" "           # GPU icon
ICONS["Total RAM"]=" "     # RAM icon

# Section icons
declare -A SEC_ICONS
SEC_ICONS["General System"]=" "  # System overview
SEC_ICONS["Tools and Libraries"]=" "  # Tools
SEC_ICONS["Hardware"]=" "  # Hardware

# =============================================================================
# Functions
# =============================================================================

# Function: get_package_version
# Description: Extracts the version of a Gentoo package from pre-fetched qlist output.
# Parameters: package_path (e.g., "sys-libs/glibc")
# Returns: Package name with version (e.g., "glibc-2.42-r2") or empty if not found.
get_package_version() {
    local pkg="$1"
    echo "$INSTALLED_PACKAGES" | grep "^$pkg-" | sort -V | tail -n1 | sed 's|.*/||'
}

# Function: detect_init_system
# Description: Detects the init system (OpenRC, systemd, s6, or Unknown).
# Returns: Init system string with version if available.
detect_init_system() {
    if command -v openrc >/dev/null 2>&1; then
        echo "OpenRC $(openrc --version 2>/dev/null | awk '/OpenRC/ {print $3}')"
    elif pidof systemd >/dev/null 2>&1; then
        echo "systemd $(systemctl --version | awk 'NR==1 {print $2}')"
    elif pidof s6-svscan >/dev/null 2>&1; then
        echo "s6-linux-init"
    else
        echo "Unknown"
    fi
}

# Function: print_section_header
# Description: Prints a section header with icon and color if enabled.
# Parameters: section_key (must match SEC_ICONS key)
print_section_header() {
    local icon="${SEC_ICONS["$1"]:-}"
    echo "${C_LABEL}${icon}=== $1 ===${RESET}"
}

# Function: print_info_line
# Description: Prints a key-value pair with icon in formatted style.
# Parameters: key, value
print_info_line() {
    local icon="${ICONS[$1]:-}"
    printf "${icon}${C_LABEL}%-15s${RESET} ${C_VALUE}%s${RESET}\n" "$1:" "$2"
}

# =============================================================================
# Data Collection
# =============================================================================

# Fetch all installed packages with versions in one go (optimization)
INSTALLED_PACKAGES=$(qlist -Iv 2>/dev/null)

# Gather general system data
MEMORY_TOTAL=$(free -m | awk '/^Mem:/ {print $2" MiB"}' || echo "N/A")
KERNEL_VERSION=$(uname -r || echo "N/A")
INIT_SYSTEM=$(detect_init_system)

# Gather hardware info
CPU_MODEL=$(awk -F ": " '/model name/ {print $2; exit}' /proc/cpuinfo || echo "N/A")
GPU_INFO=$(lspci | grep -E "VGA|3D" | sed 's/.*: //' | tr '\n' ', ' | sed 's/, $//' || echo "N/A")

# Gather package info (use associative array for organization)
declare -A PACKAGES
PACKAGES["glibc"]=$(get_package_version "sys-libs/glibc")
PACKAGES["gcc"]=$(get_package_version "sys-devel/gcc")
PACKAGES["binutils"]=$(get_package_version "sys-devel/binutils")
# PACKAGES["llvm"]=$(get_package_version "sys-devel/llvm")  # Commented out as per original
PACKAGES["xz"]=$(get_package_version "app-arch/xz-utils")
PACKAGES["python"]=$(get_package_version "dev-lang/python")
PACKAGES["mksh"]=$(get_package_version "app-shells/mksh")
PACKAGES["kitty"]=$(get_package_version "x11-terms/kitty")
PACKAGES["wayland"]=$(get_package_version "dev-libs/wayland")
PACKAGES["hyprland"]=$(get_package_version "gui-wm/hyprland")  # Updated to Hyprland
PACKAGES["pipewire"]=$(get_package_version "media-video/pipewire")

# Total packages installed
TOTAL_PACKAGES=$(echo "$INSTALLED_PACKAGES" | wc -l)
if [ "$TOTAL_PACKAGES" -eq 0 ]; then
    TOTAL_PACKAGES="N/A"
fi

# Set N/A for any empty values
for key in "${!PACKAGES[@]}"; do
    if [ -z "${PACKAGES[$key]}" ]; then
        PACKAGES[$key]="N/A"
    fi
done

# =============================================================================
# Output Sections
# =============================================================================

print_section_header "General System"
print_info_line "System" "Gentoo Linux"
print_info_line "Init" "${INIT_SYSTEM:-N/A}"
print_info_line "Kernel" "${KERNEL_VERSION:-N/A}"
print_info_line "Packages" "${TOTAL_PACKAGES:-N/A}"

echo ""

print_section_header "Tools and Libraries"
print_info_line "glibc" "${PACKAGES[glibc]:-N/A}"
print_info_line "gcc" "${PACKAGES[gcc]:-N/A}"
print_info_line "binutils" "${PACKAGES[binutils]:-N/A}"
print_info_line "xz" "${PACKAGES[xz]:-N/A}"
print_info_line "python" "${PACKAGES[python]:-N/A}"
print_info_line "mksh" "${PACKAGES[mksh]:-N/A}"
print_info_line "kitty" "${PACKAGES[kitty]:-N/A}"
print_info_line "wayland" "${PACKAGES[wayland]:-N/A}"
print_info_line "hyprland" "${PACKAGES[hyprland]:-N/A}"
print_info_line "pipewire" "${PACKAGES[pipewire]:-N/A}"

echo ""

print_section_header "Hardware"
print_info_line "CPU" "${CPU_MODEL:-N/A}"
print_info_line "GPU" "${GPU_INFO:-N/A}"
print_info_line "Total RAM" "${MEMORY_TOTAL:-N/A}"
